// === game.js (ƒë√£ c·∫≠p nh·∫≠t ƒë·ªÉ s·ª≠ d·ª•ng Socket.IO thay v√¨ WebSocket) ===
const params = new URLSearchParams(window.location.search);
const room = (params.get("room") || "lobby").trim();

// K·∫øt n·ªëi Socket.IO thay v√¨ WebSocket
const socket = io("http://localhost:5000", {
  reconnection: true,
  reconnectionAttempts: Infinity,
  reconnectionDelay: 500,
});

let username;
let currentRoom = room;

// L∆∞u tr·∫°ng th√°i v√†o localStorage ƒë·ªÉ kh√¥i ph·ª•c khi refresh
function saveGameState() {
  if (username && currentRoom) {
    localStorage.setItem('guessNumberGame', JSON.stringify({
      username: username,
      room: currentRoom,
      timestamp: Date.now()
    }));
  }
}

function loadGameState() {
  try {
    const saved = localStorage.getItem('guessNumberGame');
    if (saved) {
      const state = JSON.parse(saved);
      // Ki·ªÉm tra xem state c√≥ c√≤n h·ª£p l·ªá kh√¥ng (kh√¥ng qu√° 1 gi·ªù)
      if (Date.now() - state.timestamp < 3600000) {
        username = state.username;
        currentRoom = state.room;
        
        // C·∫≠p nh·∫≠t UI
        if (document.getElementById("username")) {
          document.getElementById("username").value = username;
        }
        if (document.getElementById("room")) {
          document.getElementById("room").value = currentRoom;
        }
        
        console.log("üîÑ Kh√¥i ph·ª•c tr·∫°ng th√°i game:", { username, currentRoom });
        return true;
      }
    }
  } catch (e) {
    console.log("‚ùå L·ªói khi kh√¥i ph·ª•c tr·∫°ng th√°i:", e);
  }
  return false;
}

// Cache elements
const joinBtn = document.getElementById("joinBtn");
const createBtn = document.getElementById("createBtn");
const joinScreen = document.getElementById("join-screen");
const gameScreen = document.getElementById("game-screen");
const chatBox = document.getElementById("chatBox");
const leaderboardList = document.getElementById("leaderboardList");
const result = document.getElementById("result");
const joinStatus = document.getElementById("joinStatus");

// ---- Helper function to show status messages
function showStatus(message, type = "info", target = "both") {
  const statusMessage = message;
  
  if (target === "both" || target === "join") {
    if (joinStatus) {
      joinStatus.textContent = statusMessage;
      joinStatus.className = `status ${type}`;
    }
  }
  
  if (target === "both" || target === "game") {
    if (result) {
      result.textContent = statusMessage;
    }
  }
}

// ---- Core functions
function switchScreen() {
  username = document.getElementById("username").value.trim() || "Kh√°ch";
  currentRoom = document.getElementById("room").value.trim() || "lobby";

  // ·∫®n m√†n h√¨nh join, hi·ªán gameplay
  joinScreen.classList.add("hidden");
  gameScreen.classList.remove("hidden");

  // K·∫øt n·ªëi Socket.IO v√† tham gia ph√≤ng
  if (socket.connected) {
    joinRoom();
  } else {
    socket.on("connect", joinRoom);
  }
}

function joinRoom() {
  // Ch·ªâ s·ª≠ d·ª•ng event m·ªõi join_room
  socket.emit("join_room", { 
    room_id: currentRoom, 
    player_name: username 
  });
}

// ---- Socket.IO event handlers
socket.on("connect", () => {
  console.log("‚úÖ K·∫øt n·ªëi Socket.IO th√†nh c√¥ng:", socket.id);
  showStatus("‚úÖ ƒê√£ k·∫øt n·ªëi t·ªõi m√°y ch·ªß", "success", "join");
  
  // N·∫øu c√≥ username v√† ƒëang ·ªü game screen, t·ª± ƒë·ªông tham gia l·∫°i ph√≤ng
  if (username && gameScreen && !gameScreen.classList.contains("hidden")) {
    console.log("üîÑ T·ª± ƒë·ªông tham gia l·∫°i ph√≤ng sau khi k·∫øt n·ªëi l·∫°i");
    joinRoom();
  }
});

socket.on("disconnect", (reason) => {
  console.log("‚ùå M·∫•t k·∫øt n·ªëi:", reason);
  showStatus("‚ùå M·∫•t k·∫øt n·ªëi t·ªõi m√°y ch·ªß", "error", "both");
});

socket.on("reconnect", () => {
  console.log("‚úÖ K·∫øt n·ªëi l·∫°i th√†nh c√¥ng!");
  showStatus("‚úÖ ƒê√£ k·∫øt n·ªëi l·∫°i th√†nh c√¥ng!", "success", "both");
  
  // N·∫øu c√≥ username v√† ƒëang ·ªü game screen, t·ª± ƒë·ªông tham gia l·∫°i ph√≤ng
  if (username && gameScreen && !gameScreen.classList.contains("hidden")) {
    console.log("üîÑ T·ª± ƒë·ªông tham gia l·∫°i ph√≤ng sau khi k·∫øt n·ªëi l·∫°i");
    joinRoom();
  }
});

socket.on("connect_error", (error) => {
  console.log("‚ùå L·ªói k·∫øt n·ªëi:", error);
  showStatus(`‚ùå L·ªói k·∫øt n·ªëi: ${error.message}`, "error", "join");
});

// ---- Modern Game events (∆∞u ti√™n s·ª≠ d·ª•ng)
socket.on("room_joined", (data) => {
  console.log("üéâ Tham gia ph√≤ng th√†nh c√¥ng:", data);
  showStatus(`‚úÖ ƒê√£ tham gia ph√≤ng ${data.room_name || currentRoom}`, "success", "game");
  
  // L∆∞u tr·∫°ng th√°i game
  saveGameState();
  
  // Hi·ªÉn th·ªã th√¥ng tin ph√≤ng
  if (data.room_info) {
    // Hi·ªÉn th·ªã b·∫£ng ƒëi·ªÉm hi·ªán t·∫°i
    if (data.room_info.scores) {
      updateLeaderboard(data.room_info.scores);
    }
    
    // Hi·ªÉn th·ªã th√¥ng tin v√≤ng hi·ªán t·∫°i
    if (data.room_info.current_round) {
      const round = data.room_info.current_round;
      showStatus(`üéÆ V√≤ng ${data.room_info.round_number}: ƒêo√°n s·ªë t·ª´ ${round.range[0]} ƒë·∫øn ${round.range[1]}`, "info", "game");
    }
    
    // Hi·ªÉn th·ªã danh s√°ch ng∆∞·ªùi ch∆°i
    if (data.room_info.players && data.room_info.players.length > 0) {
      console.log("üë• Ng∆∞·ªùi ch∆°i trong ph√≤ng:", data.room_info.players);
    }
  }
});

socket.on("join_error", (data) => {
  console.log("‚ùå L·ªói tham gia ph√≤ng:", data.error);
  showStatus(`‚ùå L·ªói: ${data.error}`, "error", "both");
});

socket.on("player_joined", (data) => {
  console.log("üëã Ng∆∞·ªùi ch∆°i tham gia:", data.player_name);
  showStatus(`üëã ${data.player_name} ƒë√£ tham gia ph√≤ng`, "info", "game");
});

socket.on("player_left", (data) => {
  console.log("üëã Ng∆∞·ªùi ch∆°i r·ªùi ph√≤ng:", data.player_name);
  showStatus(`üëã ${data.player_name} ƒë√£ r·ªùi ph√≤ng`, "info", "game");
});

socket.on("new_round", (data) => {
  console.log("üéÆ V√≤ng m·ªõi:", data);
  const roundNum = data.round_number || "?";
  const range = data.range || [1, 100];
  showStatus(`üéÆ V√≤ng ${roundNum} b·∫Øt ƒë·∫ßu! ƒêo√°n s·ªë t·ª´ ${range[0]} ƒë·∫øn ${range[1]}`, "info", "game");
});

socket.on("guess_result", (data) => {
  console.log("üí° K·∫øt qu·∫£ ƒëo√°n:", data);
  showStatus(data.message || "K·∫øt qu·∫£ ƒëo√°n", "info", "game");
});

socket.on("guess_error", (data) => {
  console.log("‚ùå L·ªói ƒëo√°n:", data.error);
  showStatus(`‚ùå L·ªói: ${data.error}`, "error", "game");
});

socket.on("chat_message", (data) => {
  console.log("üí¨ Chat:", data);
  if (chatBox) {
    const p = document.createElement("p");
    p.innerHTML = `<b>${data.player_name || "·∫®n danh"}:</b> ${data.message || ""}`;
    chatBox.appendChild(p);
    chatBox.scrollTop = chatBox.scrollHeight;
  }
});

socket.on("chat_error", (data) => {
  console.log("‚ùå L·ªói chat:", data.error);
  showStatus(`‚ùå L·ªói chat: ${data.error}`, "error", "game");
});

socket.on("scoreboard_updated", (data) => {
  console.log("üèÜ B·∫£ng ƒëi·ªÉm c·∫≠p nh·∫≠t:", data);
  updateLeaderboard(data.scores || {});
});

socket.on("room_reset", (data) => {
  console.log("üîÑ Ph√≤ng reset:", data);
  showStatus(`üîÑ Ph√≤ng ƒë√£ ƒë∆∞·ª£c reset: ${data.message}`, "info", "game");
  // Reset UI
  if (chatBox) chatBox.innerHTML = "";
  updateLeaderboard({});
});

// ---- Legacy events (ƒë·ªÉ t∆∞∆°ng th√≠ch ng∆∞·ª£c)
socket.on("round", (data) => {
  console.log("üìä V√≤ng:", data);
  const roundId = data?.round ?? "?";
  const range = data?.range || [1, 100];
  showStatus(`üìä V√≤ng ${roundId} - ƒêo√°n s·ªë t·ª´ ${range[0]} ƒë·∫øn ${range[1]}`, "info", "game");
});

socket.on("scoreboard", (data) => {
  console.log("üèÜ B·∫£ng ƒëi·ªÉm:", data);
  const scores = data?.scores || data || {};
  updateLeaderboard(scores);
});

socket.on("message", (data) => {
  console.log("üì¢ Tin nh·∫Øn:", data);
  const msg = data?.msg ?? "";
  showStatus(`üì¢ ${msg}`, "info", "game");
});

socket.on("result", (data) => {
  console.log("üéØ K·∫øt qu·∫£:", data);
  const msg = data?.msg ?? "";
  showStatus(`üéØ ${msg}`, "info", "game");
});

socket.on("chat", (data) => {
  console.log("üí¨ Chat (legacy):", data);
  if (chatBox) {
    const p = document.createElement("p");
    p.innerHTML = `<b>${data.username || "·∫®n danh"}:</b> ${data.message || ""}`;
    chatBox.appendChild(p);
    chatBox.scrollTop = chatBox.scrollHeight;
  }
});

socket.on("error", (data) => {
  console.log("‚ùå L·ªói:", data);
  const msg = data?.msg || data?.message || "L·ªói kh√¥ng x√°c ƒë·ªãnh";
  showStatus(`‚ùå ${msg}`, "error", "both");
});

// ---- Helper functions
function updateLeaderboard(scores) {
  if (!leaderboardList) return;
  
  leaderboardList.innerHTML = "";
  
  if (Object.keys(scores).length === 0) {
    const li = document.createElement("li");
    li.textContent = "Ch∆∞a c√≥ ƒëi·ªÉm s·ªë";
    leaderboardList.appendChild(li);
    return;
  }
  
  Object.entries(scores)
    .sort((a, b) => b[1] - a[1])
    .forEach(([name, score]) => {
      const li = document.createElement("li");
      li.innerHTML = `<span>${name}</span><span>${score} pts</span>`;
      leaderboardList.appendChild(li);
    });
}

// ---- Event listeners
joinBtn.addEventListener("click", switchScreen);
createBtn.addEventListener("click", switchScreen);

// G·ª≠i chat
document.getElementById("sendChat").addEventListener("click", () => {
  const msgInput = document.getElementById("chatMsg");
  const msg = msgInput.value;
  if (msg.trim() !== "" && socket && socket.connected) {
    // Ch·ªâ s·ª≠ d·ª•ng event m·ªõi chat_message
    socket.emit("chat_message", { 
      room_id: currentRoom, 
      message: msg 
    });
    
    msgInput.value = "";
  }
});

// G·ª≠i ƒëo√°n s·ªë
document.getElementById("guessBtn").addEventListener("click", () => {
  const v = document.getElementById("guessInput").value;
  const guess = parseInt(v, 10);
  if (!Number.isNaN(guess) && socket && socket.connected) {
    // Ch·ªâ s·ª≠ d·ª•ng event m·ªõi make_guess
    socket.emit("make_guess", { 
      room_id: currentRoom, 
      guess: guess 
    });
    
    document.getElementById("guessInput").value = "";
  }
});

// Enter ƒë·ªÉ g·ª≠i nhanh
document.getElementById("chatMsg").addEventListener("keydown", (e) => {
  if (e.key === "Enter") {
    document.getElementById("sendChat").click();
  }
});

document.getElementById("guessInput").addEventListener("keydown", (e) => {
  if (e.key === "Enter") {
    document.getElementById("guessBtn").click();
  }
});

// ---- Auto-join if room parameter exists
if (room && room !== "lobby") {
  console.log("üìù Ph√≤ng ƒë∆∞·ª£c ch·ªâ ƒë·ªãnh:", room);
  showStatus(`üìù Ph√≤ng ƒë∆∞·ª£c ch·ªâ ƒë·ªãnh: ${room}`, "info", "join");
} else {
  console.log("üè† Ph√≤ng m·∫∑c ƒë·ªãnh: lobby");
  showStatus("üè† Ph√≤ng m·∫∑c ƒë·ªãnh: lobby", "info", "join");
}

// Kh√¥i ph·ª•c tr·∫°ng th√°i game khi trang load
document.addEventListener('DOMContentLoaded', () => {
  console.log("üîÑ ƒêang kh√¥i ph·ª•c tr·∫°ng th√°i game...");
  if (loadGameState()) {
    console.log("‚úÖ Kh√¥i ph·ª•c tr·∫°ng th√°i th√†nh c√¥ng:", { username, currentRoom });
    showStatus(`üîÑ ƒê√£ kh√¥i ph·ª•c: ${username} trong ph√≤ng ${currentRoom}`, "info", "join");
  }
});
