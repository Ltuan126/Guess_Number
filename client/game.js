// === game.js (ƒë√£ c·∫≠p nh·∫≠t ƒë·ªÉ s·ª≠ d·ª•ng Socket.IO thay v√¨ WebSocket) ===
const params = new URLSearchParams(window.location.search);
const room = (params.get("room") || "lobby").trim();

// K·∫øt n·ªëi Socket.IO thay v√¨ WebSocket
const socket = io("http://localhost:5000", {
  reconnection: true,
  reconnectionAttempts: Infinity,
  reconnectionDelay: 500,
});

let username;
let currentRoom = room;

// L∆∞u tr·∫°ng th√°i v√†o localStorage ƒë·ªÉ kh√¥i ph·ª•c khi refresh
function saveGameState() {
  if (username && currentRoom) {
    localStorage.setItem('guessNumberGame', JSON.stringify({
      username: username,
      room: currentRoom,
      timestamp: Date.now()
    }));
  }
}

function loadGameState() {
  try {
    const saved = localStorage.getItem('guessNumberGame');
    if (saved) {
      const state = JSON.parse(saved);
      // Ki·ªÉm tra xem state c√≥ c√≤n h·ª£p l·ªá kh√¥ng (kh√¥ng qu√° 1 gi·ªù)
      if (Date.now() - state.timestamp < 3600000) {
        username = state.username;
        currentRoom = state.room;
        
        // C·∫≠p nh·∫≠t UI
        if (document.getElementById("username")) {
          document.getElementById("username").value = username;
        }
        if (document.getElementById("room")) {
          document.getElementById("room").value = currentRoom;
        }
        
        console.log("üîÑ Kh√¥i ph·ª•c tr·∫°ng th√°i game:", { username, currentRoom });
        return true;
      }
    }
  } catch (e) {
    console.log("‚ùå L·ªói khi kh√¥i ph·ª•c tr·∫°ng th√°i:", e);
  }
  return false;
}

// T·∫°o m√£ ph√≤ng ng·∫´u nhi√™n
function generateRoomId() {
  const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
  let result = '';
  for (let i = 0; i < 6; i++) {
    result += chars.charAt(Math.floor(Math.random() * chars.length));
  }
  return result;
}

// Cache elements - s·∫Ω ƒë∆∞·ª£c kh·ªüi t·∫°o khi DOM load
let joinBtn, createBtn, joinScreen, gameScreen, chatBox, leaderboardList, result, joinStatus;
let showRoomsBtn, roomsList, leaveRoomBtn, roundNumber, rangeStart, rangeEnd, copyRoomBtn;

// ---- Helper function to show status messages
function showStatus(message, type = "info", target = "both") {
  const statusMessage = message;
  
  if (target === "both" || target === "join") {
    if (joinStatus) {
      joinStatus.textContent = statusMessage;
      joinStatus.className = `status ${type}`;
    }
  }
  
  if (target === "both" || target === "game") {
    if (result) {
      result.textContent = statusMessage;
    }
  }
}

// Hi·ªÉn th·ªã danh s√°ch ph√≤ng c√≥ s·∫µn
function showAvailableRooms() {
  if (socket.connected) {
    socket.emit("get_available_rooms");
  } else {
    socket.on("connect", () => {
      socket.emit("get_available_rooms");
    });
  }
}

// C·∫≠p nh·∫≠t danh s√°ch ph√≤ng
function updateRoomsList(rooms) {
  if (!roomsList) return;
  
  roomsList.innerHTML = "";
  
  if (!rooms || rooms.length === 0) {
    const li = document.createElement("li");
    li.textContent = "Kh√¥ng c√≥ ph√≤ng n√†o";
    roomsList.appendChild(li);
    return;
  }
  
  rooms.forEach(room => {
    const li = document.createElement("li");
    li.innerHTML = `
      <div class="room-item">
        <span class="room-name">${room.name}</span>
        <span class="room-id">${room.id}</span>
        <span class="room-players">${room.player_count}/${room.max_players}</span>
        <button class="btn-join-room" onclick="joinRoomById('${room.id}')">Tham gia</button>
      </div>
    `;
    roomsList.appendChild(li);
  });
}

// Tham gia ph√≤ng theo ID
function joinRoomById(roomId) {
  document.getElementById("room").value = roomId;
  currentRoom = roomId;
  joinExistingRoom();
}

// Copy m√£ ph√≤ng
async function copyRoomId() {
  const roomInput = document.getElementById("room");
  const roomId = roomInput.value.trim();
  
  if (!roomId) {
    showStatus("‚ùå Kh√¥ng c√≥ m√£ ph√≤ng ƒë·ªÉ copy", "error", "join");
    return;
  }
  
  try {
    await navigator.clipboard.writeText(roomId);
    showStatus("‚úÖ ƒê√£ copy m√£ ph√≤ng v√†o clipboard", "success", "join");
    
    // Thay ƒë·ªïi text t·∫°m th·ªùi
    const originalText = copyRoomBtn.textContent;
    copyRoomBtn.textContent = "‚úÖ";
    setTimeout(() => {
      copyRoomBtn.textContent = originalText;
    }, 2000);
  } catch (err) {
    // Fallback cho c√°c tr√¨nh duy·ªát c≈©
    roomInput.select();
    document.execCommand("copy");
    showStatus("‚úÖ ƒê√£ copy m√£ ph√≤ng v√†o clipboard", "success", "join");
    
    // Thay ƒë·ªïi text t·∫°m th·ªùi
    const originalText = copyRoomBtn.textContent;
    copyRoomBtn.textContent = "‚úÖ";
    setTimeout(() => {
      copyRoomBtn.textContent = originalText;
    }, 2000);
  }
}

// R·ªùi ph√≤ng
function leaveRoom() {
  if (socket && socket.connected) {
    socket.emit("leave_room");
  }
  
  // Reset game state
  if (chatBox) chatBox.innerHTML = "";
  if (leaderboardList) leaderboardList.innerHTML = "";
  if (result) result.textContent = "";
  
  // Reset round info
  if (roundNumber) roundNumber.textContent = "1";
  if (rangeStart) rangeStart.textContent = "1";
  if (rangeEnd) rangeEnd.textContent = "100";
  
  // Quay v·ªÅ m√†n h√¨nh join
  gameScreen.classList.add("hidden");
  joinScreen.classList.remove("hidden");
  
  // Reset status
  if (joinStatus) {
    joinStatus.textContent = "";
    joinStatus.className = "status info";
  }
  
  console.log("üö™ ƒê√£ r·ªùi ph√≤ng:", currentRoom);
}

// ---- Core functions
function createRoom() {
  username = document.getElementById("username").value.trim() || "Kh√°ch";
  
  // T·∫°o m√£ ph√≤ng ng·∫´u nhi√™n
  const newRoomId = generateRoomId();
  const roomName = `Ph√≤ng c·ªßa ${username}`;
  
  // C·∫≠p nh·∫≠t input room v·ªõi m√£ ph√≤ng m·ªõi
  document.getElementById("room").value = newRoomId;
  currentRoom = newRoomId;
  
  // Hi·ªÉn th·ªã th√¥ng b√°o ƒëang t·∫°o ph√≤ng v·ªõi m√£ ph√≤ng
  showStatus(`üîÑ ƒêang t·∫°o ph√≤ng m·ªõi: ${newRoomId}...`, "info", "join");
  
  // G·ª≠i event t·∫°o ph√≤ng
  if (socket.connected) {
    socket.emit("create_room", {
      room_id: newRoomId,
      room_name: roomName,
      max_players: 10
    });
  } else {
    socket.on("connect", () => {
      socket.emit("create_room", {
        room_id: newRoomId,
        room_name: roomName,
        max_players: 10
      });
    });
  }
}

function joinExistingRoom() {
  username = document.getElementById("username").value.trim() || "Kh√°ch";
  currentRoom = document.getElementById("room").value.trim() || "lobby";

  // Hi·ªÉn th·ªã th√¥ng b√°o ƒëang tham gia ph√≤ng
  showStatus(`üîÑ ƒêang tham gia ph√≤ng: ${currentRoom}...`, "info", "join");

  // ·∫®n m√†n h√¨nh join, hi·ªán gameplay
  joinScreen.classList.add("hidden");
  gameScreen.classList.remove("hidden");
  
  // Hi·ªÉn th·ªã game header v√† c·∫≠p nh·∫≠t m√£ ph√≤ng
  const gameheader = document.getElementById("gameheader");
  const roomValue = document.getElementById("roomValue");
  if (gameheader && roomValue) {
    gameheader.classList.remove("hidden");
    roomValue.textContent = currentRoom;
  }

  // K·∫øt n·ªëi Socket.IO v√† tham gia ph√≤ng
  if (socket.connected) {
    joinRoom();
  } else {
    socket.on("connect", joinRoom);
  }
}

function joinRoom() {
  // Ch·ªâ s·ª≠ d·ª•ng event m·ªõi join_room
  socket.emit("join_room", { 
    room_id: currentRoom, 
    player_name: username 
  });
}

// ---- Socket.IO event handlers
socket.on("connect", () => {
  console.log("‚úÖ K·∫øt n·ªëi Socket.IO th√†nh c√¥ng:", socket.id);
  showStatus("‚úÖ ƒê√£ k·∫øt n·ªëi t·ªõi m√°y ch·ªß", "success", "join");
  
  // N·∫øu c√≥ username v√† ƒëang ·ªü game screen, t·ª± ƒë·ªông tham gia l·∫°i ph√≤ng
  if (username && gameScreen && !gameScreen.classList.contains("hidden")) {
    console.log("üîÑ T·ª± ƒë·ªông tham gia l·∫°i ph√≤ng sau khi k·∫øt n·ªëi l·∫°i");
    joinRoom();
  }
});

// Event handler cho vi·ªác t·∫°o ph√≤ng th√†nh c√¥ng
socket.on("room_created", (data) => {
  console.log("üéâ T·∫°o ph√≤ng th√†nh c√¥ng:", data);
  showStatus(`‚úÖ ƒê√£ t·∫°o ph√≤ng ${data.room_name} (${data.room_id})`, "success", "join");
  
  // C·∫≠p nh·∫≠t m√£ ph√≤ng trong input n·∫øu ch∆∞a c√≥
  if (document.getElementById("room").value !== data.room_id) {
    document.getElementById("room").value = data.room_id;
    currentRoom = data.room_id;
  }
  
  // C·∫≠p nh·∫≠t game header n·∫øu ƒë√£ hi·ªÉn th·ªã
  const roomValue = document.getElementById("roomValue");
  if (roomValue) {
    roomValue.textContent = data.room_id;
  }
  
  // Hi·ªÉn th·ªã m√£ ph√≤ng r√µ r√†ng cho ng∆∞·ªùi d√πng
  showStatus(`üéØ M√£ ph√≤ng c·ªßa b·∫°n: ${data.room_id}`, "success", "join");
  
  // T·ª± ƒë·ªông tham gia ph√≤ng v·ª´a t·∫°o sau 2 gi√¢y ƒë·ªÉ ng∆∞·ªùi d√πng th·∫•y th√¥ng b√°o v√† m√£ ph√≤ng
  setTimeout(() => {
    joinExistingRoom();
  }, 2000);
});

// Event handler cho l·ªói t·∫°o ph√≤ng
socket.on("create_room_error", (data) => {
  console.log("‚ùå L·ªói t·∫°o ph√≤ng:", data.error);
  showStatus(`‚ùå L·ªói t·∫°o ph√≤ng: ${data.error}`, "error", "join");
  
  // N·∫øu l·ªói do ph√≤ng ƒë√£ t·ªìn t·∫°i, t·∫°o m√£ ph√≤ng m·ªõi
  if (data.error.includes("ƒë√£ t·ªìn t·∫°i") || data.error.includes("already exists")) {
    setTimeout(() => {
      showStatus("üîÑ ƒêang th·ª≠ t·∫°o ph√≤ng m·ªõi...", "info", "join");
      createRoom();
    }, 2000);
  }
});

// Event handler cho danh s√°ch ph√≤ng c√≥ s·∫µn
socket.on("available_rooms", (data) => {
  console.log("üè† Danh s√°ch ph√≤ng c√≥ s·∫µn:", data.rooms);
  updateRoomsList(data.rooms);
});

socket.on("disconnect", (reason) => {
  console.log("‚ùå M·∫•t k·∫øt n·ªëi:", reason);
  showStatus("‚ùå M·∫•t k·∫øt n·ªëi t·ªõi m√°y ch·ªß", "error", "both");
});

socket.on("reconnect", () => {
  console.log("‚úÖ K·∫øt n·ªëi l·∫°i th√†nh c√¥ng!");
  showStatus("‚úÖ ƒê√£ k·∫øt n·ªëi l·∫°i th√†nh c√¥ng!", "success", "both");
  
  // N·∫øu c√≥ username v√† ƒëang ·ªü game screen, t·ª± ƒë·ªông tham gia l·∫°i ph√≤ng
  if (username && gameScreen && !gameScreen.classList.contains("hidden")) {
    console.log("üîÑ T·ª± ƒë·ªông tham gia l·∫°i ph√≤ng sau khi k·∫øt n·ªëi l·∫°i");
    joinRoom();
  }
});

socket.on("connect_error", (error) => {
  console.log("‚ùå L·ªói k·∫øt n·ªëi:", error);
  showStatus(`‚ùå L·ªói k·∫øt n·ªëi: ${error.message}`, "error", "join");
});

// ---- Modern Game events (∆∞u ti√™n s·ª≠ d·ª•ng)
socket.on("room_joined", (data) => {
  console.log("üéâ Tham gia ph√≤ng th√†nh c√¥ng:", data);
  showStatus(`‚úÖ ƒê√£ tham gia ph√≤ng ${data.room_name || currentRoom} th√†nh c√¥ng!`, "success", "game");
  
  // L∆∞u tr·∫°ng th√°i game
  saveGameState();
  
  // C·∫≠p nh·∫≠t game header v·ªõi m√£ ph√≤ng
  const roomValue = document.getElementById("roomValue");
  if (roomValue) {
    roomValue.textContent = data.room_id || currentRoom;
  }
  
  // Hi·ªÉn th·ªã th√¥ng tin ph√≤ng
  if (data.room_info) {
    // Hi·ªÉn th·ªã b·∫£ng ƒëi·ªÉm hi·ªán t·∫°i
    if (data.room_info.scores) {
      updateLeaderboard(data.room_info.scores);
    }
    
    // Hi·ªÉn th·ªã th√¥ng tin v√≤ng hi·ªán t·∫°i
    if (data.room_info.current_round) {
      const round = data.room_info.current_round;
      const roundNum = data.room_info.round_number || "?";
      
      // C·∫≠p nh·∫≠t UI v·ªõi th√¥ng tin v√≤ng hi·ªán t·∫°i
      if (roundNumber) roundNumber.textContent = roundNum;
      if (rangeStart) rangeStart.textContent = round.range[0];
      if (rangeEnd) rangeEnd.textContent = round.range[1];
      
      showStatus(`üéÆ V√≤ng ${roundNum}: ƒêo√°n s·ªë t·ª´ ${round.range[0]} ƒë·∫øn ${round.range[1]}`, "info", "game");
    }
    
    // Hi·ªÉn th·ªã danh s√°ch ng∆∞·ªùi ch∆°i
    if (data.room_info.players && data.room_info.players.length > 0) {
      console.log("üë• Ng∆∞·ªùi ch∆°i trong ph√≤ng:", data.room_info.players);
    }
  }
});

socket.on("join_error", (data) => {
  console.log("‚ùå L·ªói tham gia ph√≤ng:", data.error);
  showStatus(`‚ùå L·ªói: ${data.error}`, "error", "both");
});

socket.on("player_joined", (data) => {
  console.log("üëã Ng∆∞·ªùi ch∆°i tham gia:", data.player_name);
  showStatus(`üëã ${data.player_name} ƒë√£ tham gia ph√≤ng`, "info", "game");
});

socket.on("player_left", (data) => {
  console.log("üëã Ng∆∞·ªùi ch∆°i r·ªùi ph√≤ng:", data.player_name);
  showStatus(`üëã ${data.player_name} ƒë√£ r·ªùi ph√≤ng`, "info", "game");
});

socket.on("new_round", (data) => {
  console.log("üéÆ V√≤ng m·ªõi:", data);
  const roundNum = data.round_number || "?";
  const range = data.range || [1, 100];
  
  // C·∫≠p nh·∫≠t UI v·ªõi th√¥ng tin v√≤ng m·ªõi
  if (roundNumber) roundNumber.textContent = roundNum;
  if (rangeStart) rangeStart.textContent = range[0];
  if (rangeEnd) rangeEnd.textContent = range[1];
  
  showStatus(`üéÆ V√≤ng ${roundNum} b·∫Øt ƒë·∫ßu! ƒêo√°n s·ªë t·ª´ ${range[0]} ƒë·∫øn ${range[1]}`, "info", "game");
  
  // Reset result
  if (result) result.textContent = "";
});

socket.on("guess_result", (data) => {
  console.log("üí° K·∫øt qu·∫£ ƒëo√°n:", data);
  showStatus(data.message || "K·∫øt qu·∫£ ƒëo√°n", "info", "game");
});

socket.on("guess_error", (data) => {
  console.log("‚ùå L·ªói ƒëo√°n:", data.error);
  showStatus(`‚ùå L·ªói: ${data.error}`, "error", "game");
});

socket.on("chat_message", (data) => {
  console.log("üí¨ Chat:", data);
  if (chatBox) {
    const p = document.createElement("p");
    p.innerHTML = `<b>${data.player_name || "·∫®n danh"}:</b> ${data.message || ""}`;
    chatBox.appendChild(p);
    chatBox.scrollTop = chatBox.scrollHeight;
  }
});

socket.on("chat_error", (data) => {
  console.log("‚ùå L·ªói chat:", data.error);
  showStatus(`‚ùå L·ªói chat: ${data.error}`, "error", "game");
});

socket.on("scoreboard_updated", (data) => {
  console.log("üèÜ B·∫£ng ƒëi·ªÉm c·∫≠p nh·∫≠t:", data);
  updateLeaderboard(data.scores || {});
});

socket.on("room_reset", (data) => {
  console.log("üîÑ Ph√≤ng reset:", data);
  showStatus(`üîÑ Ph√≤ng ƒë√£ ƒë∆∞·ª£c reset: ${data.message}`, "info", "game");
  // Reset UI
  if (chatBox) chatBox.innerHTML = "";
  updateLeaderboard({});
});

// ---- Legacy events (ƒë·ªÉ t∆∞∆°ng th√≠ch ng∆∞·ª£c)
socket.on("round", (data) => {
  console.log("üìä V√≤ng:", data);
  const roundId = data?.round ?? "?";
  const range = data?.range || [1, 100];
  
  // C·∫≠p nh·∫≠t UI v·ªõi th√¥ng tin v√≤ng
  if (roundNumber) roundNumber.textContent = roundId;
  if (rangeStart) rangeStart.textContent = range[0];
  if (rangeEnd) rangeEnd.textContent = range[1];
  
  showStatus(`üìä V√≤ng ${roundId} - ƒêo√°n s·ªë t·ª´ ${range[0]} ƒë·∫øn ${range[1]}`, "info", "game");
});

socket.on("scoreboard", (data) => {
  console.log("üèÜ B·∫£ng ƒëi·ªÉm:", data);
  const scores = data?.scores || data || {};
  updateLeaderboard(scores);
});

socket.on("message", (data) => {
  console.log("üì¢ Tin nh·∫Øn:", data);
  const msg = data?.msg ?? "";
  showStatus(`üì¢ ${msg}`, "info", "game");
});

socket.on("result", (data) => {
  console.log("üéØ K·∫øt qu·∫£:", data);
  const msg = data?.msg ?? "";
  showStatus(`üéØ ${msg}`, "info", "game");
});

socket.on("chat", (data) => {
  console.log("üí¨ Chat (legacy):", data);
  if (chatBox) {
    const p = document.createElement("p");
    p.innerHTML = `<b>${data.username || "·∫®n danh"}:</b> ${data.message || ""}`;
    chatBox.appendChild(p);
    chatBox.scrollTop = chatBox.scrollHeight;
  }
});

socket.on("error", (data) => {
  console.log("‚ùå L·ªói:", data);
  const msg = data?.msg || data?.message || "L·ªói kh√¥ng x√°c ƒë·ªãnh";
  showStatus(`‚ùå ${msg}`, "error", "both");
});

// ---- Helper functions
function updateLeaderboard(scores) {
  if (!leaderboardList) return;
  
  leaderboardList.innerHTML = "";
  
  if (Object.keys(scores).length === 0) {
    const li = document.createElement("li");
    li.textContent = "Ch∆∞a c√≥ ƒëi·ªÉm s·ªë";
    leaderboardList.appendChild(li);
    return;
  }
  
  Object.entries(scores)
    .sort((a, b) => b[1] - a[1])
    .forEach(([name, score]) => {
      const li = document.createElement("li");
      li.innerHTML = `<span>${name}</span><span>${score} pts</span>`;
      leaderboardList.appendChild(li);
    });
}

// ---- Event listeners
// Kh√¥i ph·ª•c tr·∫°ng th√°i game khi trang load
document.addEventListener('DOMContentLoaded', () => {
  console.log("üîÑ ƒêang kh√¥i ph·ª•c tr·∫°ng th√°i game...");
  
  // Kh·ªüi t·∫°o elements
  initializeElements();
  
  if (loadGameState()) {
    console.log("‚úÖ Kh√¥i ph·ª•c tr·∫°ng th√°i th√†nh c√¥ng:", { username, currentRoom });
    showStatus(`üîÑ ƒê√£ kh√¥i ph·ª•c: ${username} trong ph√≤ng ${currentRoom}`, "info", "join");
    
    // N·∫øu c√≥ room parameter trong URL, t·ª± ƒë·ªông chuy·ªÉn v√†o game
    if (room && room !== "lobby") {
      setTimeout(() => {
        joinExistingRoom();
      }, 1000);
    }
  }
});

// Kh·ªüi t·∫°o elements v√† event listeners
function initializeElements() {
  // Cache elements
  joinBtn = document.getElementById("joinBtn");
  createBtn = document.getElementById("createBtn");
  joinScreen = document.getElementById("join-screen");
  gameScreen = document.getElementById("game-screen");
  chatBox = document.getElementById("chatBox");
  leaderboardList = document.getElementById("leaderboardList");
  result = document.getElementById("result");
  joinStatus = document.getElementById("joinStatus");
  
  // Th√™m n√∫t hi·ªÉn th·ªã danh s√°ch ph√≤ng
  showRoomsBtn = document.getElementById("showRoomsBtn");
  roomsList = document.getElementById("roomsList");
  
  // Game elements
  leaveRoomBtn = document.getElementById("leaveRoomBtn");
  roundNumber = document.getElementById("roundNumber");
  rangeStart = document.getElementById("rangeStart");
  rangeEnd = document.getElementById("rangeEnd");
  
  // Copy elements
  copyRoomBtn = document.getElementById("copyRoomBtn");
  
  // Th√™m event listeners
  if (joinBtn) joinBtn.addEventListener("click", joinExistingRoom);
  if (createBtn) createBtn.addEventListener("click", createRoom);
  if (showRoomsBtn) showRoomsBtn.addEventListener("click", toggleRoomsList);
  if (leaveRoomBtn) leaveRoomBtn.addEventListener("click", leaveRoom);
  if (copyRoomBtn) copyRoomBtn.addEventListener("click", copyRoomId);
  
  // Event listeners cho chat v√† game
  const sendChatBtn = document.getElementById("sendChat");
  const guessBtn = document.getElementById("guessBtn");
  const chatMsg = document.getElementById("chatMsg");
  const guessInput = document.getElementById("guessInput");
  const roomInput = document.getElementById("room");
  const usernameInput = document.getElementById("username");
  
  if (sendChatBtn) sendChatBtn.addEventListener("click", sendChat);
  if (guessBtn) guessBtn.addEventListener("click", makeGuess);
  if (chatMsg) chatMsg.addEventListener("keydown", (e) => e.key === "Enter" && sendChat());
  if (guessInput) guessInput.addEventListener("keydown", (e) => e.key === "Enter" && makeGuess());
  if (roomInput) roomInput.addEventListener("keydown", (e) => e.key === "Enter" && joinExistingRoom());
  if (usernameInput) usernameInput.addEventListener("keydown", (e) => e.key === "Enter" && roomInput.focus());
  
  console.log("‚úÖ ƒê√£ kh·ªüi t·∫°o elements v√† event listeners");
  
  // Auto-join if room parameter exists
  if (room && room !== "lobby") {
    console.log("üìù Ph√≤ng ƒë∆∞·ª£c ch·ªâ ƒë·ªãnh:", room);
    showStatus(`üìù Ph√≤ng ƒë∆∞·ª£c ch·ªâ ƒë·ªãnh: ${room}`, "info", "join");
  } else {
    console.log("üè† Ph√≤ng m·∫∑c ƒë·ªãnh: lobby");
    showStatus("üè† Ph√≤ng m·∫∑c ƒë·ªãnh: lobby", "info", "join");
  }
}

// Toggle danh s√°ch ph√≤ng
function toggleRoomsList() {
  if (roomsList.classList.contains("hidden")) {
    roomsList.classList.remove("hidden");
    showRoomsBtn.textContent = "üìã ·∫®n danh s√°ch ph√≤ng";
    showAvailableRooms();
  } else {
    roomsList.classList.add("hidden");
    showRoomsBtn.textContent = "üìã Xem ph√≤ng c√≥ s·∫µn";
  }
}

// G·ª≠i chat
function sendChat() {
  const msgInput = document.getElementById("chatMsg");
  const msg = msgInput.value;
  if (msg.trim() !== "" && socket && socket.connected) {
    socket.emit("chat_message", { 
      room_id: currentRoom, 
      message: msg 
    });
    msgInput.value = "";
  }
}

// G·ª≠i ƒëo√°n s·ªë
function makeGuess() {
  const v = document.getElementById("guessInput").value;
  const guess = parseInt(v, 10);
  if (!Number.isNaN(guess) && socket && socket.connected) {
    socket.emit("make_guess", { 
      room_id: currentRoom, 
      guess: guess 
    });
    document.getElementById("guessInput").value = "";
  }
}
